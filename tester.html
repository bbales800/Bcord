<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>BCord WebSocket Tester</title>
    <style>
        body { font-family: system-ui, Arial, sans-serif; max-width: 820px; margin: 2rem auto; }
        input, button { padding: 6px; margin: 4px; }
        #log { border: 1px solid #ccc; height: 360px; overflow-y: auto; padding: 8px; background: #111; color: #ddd; }
        .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    </style>
</head>
<body>
<h1>BCord WebSocket Tester</h1>

<div class="row">
    <label>Server (ws / wss):</label>
    <input id="url" size="48">
    <label>Channel:</label>
    <input id="channel" value="general">
</div>

<div class="row">
    <label>Nickname:</label>
    <input id="nick" value="Tester">
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
</div>

<div class="row">
    <label>Message:</label>
    <input id="message" size="64" placeholder='Type then click "Send"'>
</div>
<button id="send">Send</button>

<h3>History</h3>
<div class="row">
    <label>History channel:</label>
    <input id="histChan" value="general">
    <label>Limit:</label>
    <input id="histLimit" value="10">
    <button id="getHistory">Fetch History</button>
</div>

<h3>Log</h3>
<div id="log"></div>

<script>
    let ws;

    function $(id){ return document.getElementById(id); }
    function log(...args){
        const s = args.map(a => typeof a==='string'? a : JSON.stringify(a)).join(' ');
        const line = `[${new Date().toLocaleTimeString()}] ${s}`;
        const div = document.createElement('div');
        div.textContent = line;
        const el = $('log'); el.appendChild(div); el.scrollTop = el.scrollHeight;
    }

    function defaultWS() {
        // If served over HTTPS by Caddy, prefer WSS to same host at path /ws
        if (location.protocol === 'https:') return `wss://${location.host}/ws`;
        // If served via plain http or file://, keep whatever is typed (fallback)
        return $('url').value || 'ws://127.0.0.1:9000';
    }

    function connect() {
        const url = $('url').value.trim() || defaultWS();
        $('url').value = url;
        log('Connecting to', url);
        ws = new WebSocket(url);
        ws.onopen = () => {
            log('Connected.');
            const nick = $('nick').value.trim() || 'Tester';
            const ch = $('channel').value.trim() || 'general';
            ws.send(JSON.stringify({op:'hello', nick}));
            ws.send(JSON.stringify({op:'join', channel: ch}));
        };
        ws.onclose = () => log('Closed.');
        ws.onerror = (e) => log('ERROR', e.message || JSON.stringify(e));
        ws.onmessage = (ev) => {
            log('recv', ev.data);
            // pretty-print history payloads if desired
            try {
                const msg = JSON.parse(ev.data);
                if (msg.op === 'history') log('history items', JSON.stringify(msg.items, null, 2));
            } catch(_) {}
        };
    }

    function disconnect(){ if (ws) ws.close(); }

    function send() {
        if (!ws || ws.readyState !== WebSocket.OPEN) { log('⚠️ not connected'); return; }
        const ch = $('channel').value.trim() || 'general';
        const text = $('message').value;
        ws.send(JSON.stringify({op:'msg', channel: ch, text}));
    }

    $('connect').onclick = connect;
    $('disconnect').onclick = disconnect;
    $('send').onclick = send;

    // history button
    $('getHistory').onclick = () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) { log('⚠️ not connected'); return; }
        const ch = $('histChan').value.trim() || 'general';
        const limit = parseInt($('histLimit').value || '10', 10);
        ws.send(JSON.stringify({op:'history', channel: ch, limit}));
    };

    // on load, suggest a sensible default WSS URL when served via Caddy
    window.addEventListener('DOMContentLoaded', () => {
        if (location.protocol === 'https:') $('url').value = `wss://${location.host}/ws`;
    });
</script>
</body>
</html>
